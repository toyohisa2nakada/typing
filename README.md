# 0. 概要

* タイピングゲームを作るための「ローマ字入力の正誤判定」を行うJavaScriptライブラリです
* 例えば「ひっしゅう」は、hisshuu, hisshilyuu, hiltushilyuuなどと複数の入力パターンがあります。それらを網羅した入力正誤判定を行うことができます
* ひらがな と、ローマ字のどこまでをすでに打ったのかを得ることができます

# 1. このライブラリを使用して作成したタイピングゲームの例

* [翔べ!ガンダムの歌詞](https://toyohisa2nakada.github.io/typing/simple_typing_game.html?%5B%5B%22%E3%82%82%E3%81%88%E3%81%82%E3%81%8C%E3%82%8C%22%2C%22%E7%87%83%E3%81%88%E4%B8%8A%E3%82%8C%22%5D%2C%5B%22%E3%82%82%E3%81%88%E3%81%82%E3%81%8C%E3%82%8C%22%2C%22%E7%87%83%E3%81%88%E4%B8%8A%E3%82%8C%22%5D%2C%5B%22%E3%82%82%E3%81%88%E3%81%82%E3%81%8C%E3%82%8C%22%2C%22%E7%87%83%E3%81%88%E4%B8%8A%E3%81%8C%E3%82%8C%22%5D%2C%5B%22%E3%81%8C%E3%82%93%E3%81%A0%E3%82%80%22%2C%22%E3%82%AC%E3%83%B3%E3%83%80%E3%83%A0%22%5D%2C%5B%22%E3%81%8D%E3%81%BF%E3%82%88%22%2C%22%E5%90%9B%E3%82%88%22%5D%2C%5B%22%E3%81%AF%E3%81%97%E3%82%8C%22%2C%22%E8%B5%B0%E3%82%8C%22%5D%2C%5B%22%E3%81%BE%E3%81%A0%E3%81%84%E3%81%8B%E3%82%8A%E3%81%AB%E3%82%82%E3%81%88%E3%82%8B%22%2C%22%E3%81%BE%E3%81%A0%E6%80%92%E3%82%8A%E3%81%AB%E7%87%83%E3%81%88%E3%82%8B%22%5D%2C%5B%22%E3%81%A8%E3%81%86%E3%81%97%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AA%E3%82%89%22%2C%22%E9%97%98%E5%BF%97%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AA%E3%82%89%22%5D%2C%5B%22%E3%81%8D%E3%82%87%E3%81%A0%E3%81%84%E3%81%AA%E3%81%A6%E3%81%8D%E3%82%92%22%2C%22%E5%B7%A8%E5%A4%A7%E3%81%AA%E6%95%B5%E3%82%92%22%5D%2C%5B%22%E3%81%86%E3%81%A6%E3%82%88%22%2C%22%E8%A8%8E%E3%81%A6%E3%82%88%22%5D%2C%5B%22%E3%81%86%E3%81%A6%E3%82%88%22%2C%22%E8%A8%8E%E3%81%A6%E3%82%88%22%5D%2C%5B%22%E3%81%86%E3%81%A6%E3%82%88%22%2C%22%E8%A8%8E%E3%81%A6%E3%82%88%22%5D%2C%5B%22%E3%81%9B%E3%81%84%E3%81%8E%E3%81%AE%E3%81%84%E3%81%8B%E3%82%8A%E3%82%92%22%2C%22%E6%AD%A3%E7%BE%A9%E3%81%AE%E6%80%92%E3%82%8A%E3%82%92%22%5D%2C%5B%22%E3%81%B6%E3%81%A4%E3%81%91%E3%82%8D%22%2C%22%E3%81%B6%E3%81%A4%E3%81%91%E3%82%8D%22%5D%2C%5B%22%E3%81%8C%E3%82%93%E3%81%A0%E3%82%80%22%2C%22%E3%82%AC%E3%83%B3%E3%83%80%E3%83%A0%22%5D%2C%5B%22%E3%81%8D%E3%81%A9%E3%81%86%E3%81%9B%E3%82%93%E3%81%97%22%2C%22%E6%A9%9F%E5%8B%95%E6%88%A6%E5%A3%AB%22%5D%2C%5B%22%E3%81%8C%E3%82%93%E3%81%A0%E3%82%80%22%2C%22%E3%82%AC%E3%83%B3%E3%83%80%E3%83%A0%22%5D%2C%5B%22%E3%81%8C%E3%82%93%E3%81%A0%E3%82%80%22%2C%22%E3%82%AC%E3%83%B3%E3%83%80%E3%83%A0%22%5D%5D)
* [写経：般若心経](https://toyohisa2nakada.github.io/typing/simple_typing_game.html?%5B%5B%22%E3%81%B6%E3%81%A3%E3%81%9B%E3%81%A4%E3%81%BE%E3%81%8B%E3%81%AF%E3%82%93%E3%81%AB%E3%82%83%E3%81%AF%E3%82%89%E3%81%BF%E3%81%9F%E3%81%97%E3%82%93%E3%81%8E%E3%82%87%E3%81%86%22%2C%22%E4%BB%8F%E8%AA%AC%E6%91%A9%E8%A8%B6%E8%88%AC%E8%8B%A5%E6%B3%A2%E7%BE%85%E8%9C%9C%E5%A4%9A%E5%BF%83%E7%B5%8C%22%5D%2C%5B%22%E3%81%8B%E3%82%93%E3%81%98%E3%81%96%E3%81%84%E3%81%BC%E3%81%95%E3%81%8E%E3%82%87%E3%81%86%E3%81%98%E3%82%93%E3%81%AF%E3%82%93%E3%81%AB%E3%82%83%E3%81%AF%E3%82%89%E3%81%BF%E3%81%9F%22%2C%22%E8%A6%B3%E8%87%AA%E5%9C%A8%E8%8F%A9%E8%96%A9%E8%A1%8C%E6%B7%B1%E8%88%AC%E8%8B%A5%E6%B3%A2%E7%BE%85%E8%9C%9C%E5%A4%9A%22%5D%2C%5B%22%E3%81%98%E3%81%97%E3%82%87%E3%81%86%E3%81%91%E3%82%93%E3%81%94%E3%81%86%E3%82%93%E3%81%8B%E3%81%84%E3%81%8F%E3%81%A9%E3%81%84%E3%81%A3%E3%81%95%E3%81%84%E3%81%8F%E3%82%84%E3%81%8F%22%2C%22%E6%99%82%E7%85%A7%E8%A6%8B%E4%BA%94%E8%98%8A%E7%9A%86%E7%A9%BA%E5%BA%A6%E4%B8%80%E5%88%87%E8%8B%A6%E5%8E%84%22%5D%2C%5B%22%E3%81%97%E3%82%83%E3%82%8A%E3%81%97%E3%81%97%E3%81%8D%E3%81%B5%E3%81%84%E3%81%8F%E3%81%86%E3%81%8F%E3%81%86%E3%81%B5%E3%81%84%E3%81%97%E3%81%8D%E3%81%97%E3%81%8D%E3%81%9D%E3%81%8F%E3%81%9C%22%2C%22%E8%88%8E%E5%88%A9%E5%AD%90%E8%89%B2%E4%B8%8D%E7%95%B0%E7%A9%BA%E7%A9%BA%E4%B8%8D%E7%95%B0%E8%89%B2%E8%89%B2%E5%8D%B3%E6%98%AF%22%5D%2C%5B%22%E3%81%8F%E3%81%86%E3%81%8F%E3%81%86%E3%81%9D%E3%81%8F%E3%81%9C%E3%81%97%E3%81%8D%E3%81%98%E3%82%85%E3%81%9D%E3%81%86%E3%81%8E%E3%82%87%E3%81%86%E3%81%97%E3%81%8D%E3%82%84%E3%81%8F%E3%81%B6%E3%81%AB%E3%82%87%E3%81%9C%22%2C%22%E7%A9%BA%E7%A9%BA%E5%8D%B3%E6%98%AF%E8%89%B2%E5%8F%97%E6%83%B3%E8%A1%8C%E8%AD%98%E4%BA%A6%E5%BE%A9%E5%A6%82%E6%98%AF%22%5D%5D)
* [円周率](https://toyohisa2nakada.github.io/typing/simple_typing_game.html?%5B%5B%223.%22%2C%221%E6%A1%81%E7%9B%AE%E3%81%A8%E5%B0%8F%E6%95%B0%E7%82%B9%22%5D%2C%5B%22141592653589%22%2C%22%E5%B0%8F%E6%95%B0%E7%82%B91%E6%A1%81%E7%9B%AE%E3%81%8B%E3%82%8912%E6%A1%81%E7%9B%AE%22%5D%2C%5B%22793238462643%22%2C%22%E5%B0%8F%E6%95%B0%E7%82%B913%E6%A1%81%E7%9B%AE%E3%81%8B%E3%82%8924%E6%A1%81%E7%9B%AE%22%5D%2C%5B%22383279502884%22%2C%22%E5%B0%8F%E6%95%B0%E7%82%B925%E6%A1%81%E7%9B%AE%E3%81%8B%E3%82%8936%E6%A1%81%E7%9B%AE%22%5D%2C%5B%22197169399375%22%2C%22%E5%B0%8F%E6%95%B0%E7%82%B937%E6%A1%81%E7%9B%AE%E3%81%8B%E3%82%8948%E6%A1%81%E7%9B%AE%22%5D%2C%5B%22105820974944%22%2C%22%E5%B0%8F%E6%95%B0%E7%82%B949%E6%A1%81%E7%9B%AE%E3%81%8B%E3%82%8960%E6%A1%81%E7%9B%AE%22%5D%2C%5B%22592307816406%22%2C%22%E5%B0%8F%E6%95%B0%E7%82%B961%E6%A1%81%E7%9B%AE%E3%81%8B%E3%82%8972%E6%A1%81%E7%9B%AE%22%5D%2C%5B%22286208998628%22%2C%22%E5%B0%8F%E6%95%B0%E7%82%B973%E6%A1%81%E7%9B%AE%E3%81%8B%E3%82%8984%E6%A1%81%E7%9B%AE%22%5D%2C%5B%22034825342117%22%2C%22%E5%B0%8F%E6%95%B0%E7%82%B985%E6%A1%81%E7%9B%AE%E3%81%8B%E3%82%8996%E6%A1%81%E7%9B%AE%22%5D%5D)
* [英単語の勉強](https://toyohisa2nakada.github.io/typing/simple_typing_game.html?%5B%5B%22invade%22%2C%22%E4%BE%B5%E7%95%A5%E3%81%99%E3%82%8B%22%5D%2C%5B%22lift%22%2C%22%E4%B8%8A%E3%81%92%E3%82%8B%22%5D%2C%5B%22mental%22%2C%22%E7%B2%BE%E7%A5%9E%E3%81%AE%22%5D%2C%5B%22majority%22%2C%22%E5%A4%A7%E5%A4%9A%E6%95%B0%E3%80%81%E5%A4%A7%E9%83%A8%E5%88%86%22%5D%2C%5B%22quiet%22%2C%22%E9%9D%99%E3%81%8B%E3%81%AA%22%5D%2C%5B%22stay%22%2C%22%E6%B3%8A%E3%81%BE%E3%82%8B%E3%80%81%E6%BB%9E%E5%9C%A8%E3%81%99%E3%82%8B%22%5D%2C%5B%22thin%22%2C%22%E8%96%84%E3%81%84%E3%80%81%E7%B4%B0%E3%81%84%22%5D%5D)
* [休暇願を上司に送る？](https://toyohisa2nakada.github.io/typing/simple_typing_game.html?%5B%5B%22%E3%81%8A%E3%81%A4%E3%81%8B%E3%82%8C%E3%81%95%E3%81%BE%E3%81%A7%E3%81%99%E3%80%82%22%2C%22%E3%81%8A%E7%96%B2%E3%82%8C%E6%A7%98%E3%81%A7%E3%81%99%E3%80%82%22%5D%2C%5B%22%E3%81%93%E3%81%AE%E3%81%9F%E3%81%B3%22%2C%22%E3%81%93%E3%81%AE%E5%BA%A6%22%5D%2C%5B%22%E3%82%86%E3%81%86%E3%81%8D%E3%82%85%E3%81%86%E3%81%8D%E3%82%85%E3%81%86%E3%81%8B%E3%82%92%22%2C%22%E6%9C%89%E7%B5%A6%E4%BC%91%E6%9A%87%E3%82%92%22%5D%2C%5B%22%E3%81%97%E3%82%85%E3%81%A8%E3%81%8F%E3%81%97%E3%81%9F%E3%81%8F%22%2C%22%E5%8F%96%E5%BE%97%E3%81%97%E3%81%9F%E3%81%8F%22%5D%2C%5B%22%E3%81%93%E3%81%93%E3%81%AB%22%2C%22%E3%81%93%E3%81%93%E3%81%AB%22%5D%2C%5B%22%E3%81%8A%E3%81%A8%E3%81%A9%E3%81%91%E3%81%84%E3%81%9F%E3%81%97%E3%81%BE%E3%81%99%E3%80%82%22%2C%22%E3%81%8A%E5%B1%8A%E3%81%91%E3%81%84%E3%81%9F%E3%81%97%E3%81%BE%E3%81%99%E3%80%82%22%5D%5D)
* [Pythonプログラム](https://toyohisa2nakada.github.io/typing/simple_typing_game.html?%5B%5B%22import%20random%5Cnrandom.seed(0)%5Cnar%20%3D%20%5Brandom.random()%20for%20i%20in%20range(16)%5D%5Cnprint(f%5C%22list%3D%7Bar%7D%5C%22)%5Cnsum_gusu_idx%20%3D%200%5Cnfor%20i%2Cv%20in%20enumerate(ar)%3A%5Cn%20%20%20%20if%20i%20%25%202%20%3D%3D%200%3A%5Cn%20%20%20%20%20%20%20%20sum_gusu_idx%20%2B%3D%20v%5Cnprint(f%5C%22the%20sum%20of%20the%20numbers%20at%20even%20indices%20is%20%7Bsum_gusu_idx%7D.%5C%22)%22%5D%5D)

# 2. ダウンロード

https://github.com/toyohisa2nakada/typing/tree/main

ライブラリは、keygraph.js ファイルです。
simple_typing_game.htmlファイルがライブラリを使ったタイピングゲームの例です。
simple_typing_game.htmlでは、keygraph.js以外にsound.jsファイルも読み込みます。

# 3. ライブラリの使い方

```html:simple_typing_game.html

<script type="module">
    // ライブラリの読み込み(type="module"のスクリプトで実行してください)
    import { keygraph } from "./keygraph.js";
    
    // DAGの作成、keygraph.jsを読み込むとkeygraph変数が使えるようになります。
    keygraph.build("ひっしゅう");

    // これから打つキー、すでに打ったキーを表示、 ... は適宜変更してください。
    const disp = ()=>{
        // これからタイプしなければいけないキーの取得
        document.getElementById("...").innerText = keygraph.key_candidate();

        // タイプし終わったキーの取得
        document.getElementById("...").innerText = keygraph.key_done();

        // これから打つ ひらがな の取得
        document.getElementById("...").innerText = keygraph.seq_candidates();
    
        // 打ち終わった ひらがな の取得
        document.getElementById("...").innerText = keygraph.seq_done();
    }

    // keydownのイベント処理
    document.body.addEventListener("keydown", e => {
        if (keygraph.next(e.key)) {
            // 入力がタイピングするキーと一致している場合
        }
        if (keygraph.is_finished()) {
            // すべての文字をタイプし終わったとき
        }
        disp();
    });
    disp();
</script>
```


<details><summary>これからタイプしなければいけないローマ字について</summary><div>
タイピングゲームでは、タイプするローマ字を画面に表示することがよくあります。例えば「ひっしゅう」ならば「hisshu」という文字が表示されて、すでに打った文字が暗くなったりしてどこまで打ったのかをユーザが分かるようにします。この「hisshu」に相当する文字列を取得するのが keygraph.key_candidate 関数です。keygraph.key_candidateは、「hisshu」や「hisshilyuu」のように複数のパターンから「1つ」が選ばれて文字列として戻るわけですが、その選ばれる基準は、keygraph.jsファイルの下の方で定義されている_char_keys_tableリストの順序で決まります。リストの上の方、また同じ ひらがな ならば keys変数で定義されたキー候補の左の方が優先されます。例えば「っしゅ」の場合、_char_keys_tableリストの「っ」「っし」「っしゅ」の3つがまず候補になるのですが、最もリストの上にある「っしゅ」が選ばれます。そして「っしゅ」のキー候補である["ssyu", "sshu"]のうち左側の"ssyu"が選ばれることになります。例えば「っし」が_char_keys_tableリストの上位にあれば「っし」のkeys変数の左側が選ばれ、そして残りの文字の「ゅ」の定義の中でkeys変数の左側のローマ字が選ばれて全部のローマ字が完成するということになります。よって画面に表示するローマ字を変更したい場合、_char_keys_tableリストのデータの順序を入れ替えることで対応できます。
</div></details>

# 4. タイプする文字を自分で作成するアプリ

### 追記（2025.04.18）
以前は「gooラボ」のひらがな変換サービスを使って、漢字を自動的にひらがなに変換していましたが、このサービスはすでに終了しています。そのため、現在は自動変換ができません。
このデモでは、次のように入力してください：
- 左側の欄には、タイピングゲームで上に表示される元の文字（通常は漢字を含む文章）を入力します
- 右側の欄には、その文字をタイピングするときに入力する「ひらがな」を自分で入力してください

[オンラインデモ](https://toyohisa2nakada.github.io/typing/simple_typing_game_maker.html)

タイピングゲームのアプリ例である simple_typing_game.html は、URL引数によってタイプする文字を指定することができます。以下のは、そのURL引数を作成するアプリの例です。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/275020/faa21fa5-edb7-3749-7af3-460ffc7b55d0.png)
↑ の左側で漢字混じりの日本語を打つと、右側に ひらがな が自動作成されます。自動変換された ひらがな は、間違えていれば自分で修正することもできます。登録した文字を打つタイピングゲームのURLは画面下に表示され、URLにマウスをもっていくと「実行」「URLの短縮」「URLのコピー」のそれぞれのボタンが表示されます。URLの文字数が最大の4096文字になるまで文字を追加することができます。

<details><summary>ひらがな 自動変換について</summary><div>
ひらがな への自動変換は、<a href="https://labs.goo.ne.jp/">gooらぼ</a>の ひらがな化APIを使用させていただいています。</div></details>

<details><summary>短縮URLについて</summary><div>
URL短縮には、<a href="https://tinyurl.com/app/dev">TinyURL OpenApi</a>を使用させていただいています。</div></details>

# 5. ライブラリは、ひらがな からキーパターンを網羅した有向非巡回グラフ(DAG)を作成します

有向非巡回グラフとは、グラフ理論における閉路のない有向グラフのことです。ライブラリに「**ひっしゅう**」と入力すると、以下のようなDAGを作成します。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/275020/83feece4-fe5f-080c-3f92-37d7ddd92f4f.png)
グラフ理論では、丸いものを「ノード」、その丸を繋ぐ矢印を「エッジ」と呼びます。DAGの場合はエッジに方向が付いていて、片方にしかDAG内を移動することができません。また1つのノードからスタートして同じノードに戻ってくるという巡回経路がありません。

↑ の例で「HEAD」は、このDAGをたどる最初のノードと、このライブラリではしています。HEAD以外のノードには「h」などのキーが割り当てられていて、そのキー打つとそのノードに達する、という感じです。また「ひ」などの ひらがな が書かれているノードは、そのノードに達したときにその ひらがな までが打ち終わったことを表します。

このDAGは次のようにして使われます。

1. まず、このDAGの現在位置を「HEAD」とします。
1. キー入力があったときに、現在位置の先に移動できるキーならば、現在位置を移動させます。例えば「HEAD」に現在位置があるときは、「h」キーが入力されたときだけ現在位置が「h」のノードに移動します。
1. 移動先のない終端のノードに着いたら、タイピングが完了したことを表します。上のDAGの場合は、「う」と書かれているノードが終端のノードです。

「ひっしゅう」のDAGでは、まず最初の「ひ」は「hi」しか選択肢がないので、「HEAD」「h」「i」とDAGをたどる経路は1本道となっています。そして「i」の先は4つに分かれています。たとえば「sshu」と辿ると「っしゅ」までを一度にタイプできて、「っ」「し」「っ」を1文字ずつタイプするような場合は、「xtu」「xtsu」「ltu」「ltsu」のどれかをたどって「っ」のノードまでたどり着きます。そこから「si」「ci」のどちらかの経路で「し」まで到達し....と続いて最後の「う」のノードまでたどり着けば「ひっしゅう」を打ち終わったことになります。

# 6. ひらがな からDAGを作るためのアルゴリズム

### 6.1. アルゴリズムの概要

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/275020/12e708a3-c71e-9b91-b9b0-297c8f8899b7.png)
↑ の例は、架空のある ひらがな"〇" を打つキーが"abde", "acde"の2種類ある場合のDAG作成例です。まず最初の"abde"の1文字が1ノードとなってグラフになります。次に"acde"を作成するわけですが、最初の文字から順にすでにDAGにあるキーは、この場合は"a"は、同じノードを共有します。次の"c"は先に作った"abde"の"b"とは異なるので"a"から枝分かれします。そしてそのあとの"d","e"は"c"の後につながります。"d","e"は1つ目のキーですでにノードが作られているわけですが、一度枝分かれしたらそのあとはノードを統合せずに別れたまま進みます。

そしてすべてのキーパターンがDAGに入ったら、最後に追加したノードのマージ処理を行います。この例の場合は、2つの"e"ノードが対象です。同じノードは1つにマージして、さらにマージした"d"ノードの親もマージして、と続いてマージできないところまでさかのぼってマージを繰り返します。

このノードのマージは、マージ対象のノードがすべてDAGに追加されてから処理が開始されます。例えば上記の場合は、ある架空の〇文字だけを対象としていますが、「っ〇」「〇」と「〇」文字まで到達する ひらがな の経路が複数ある場合も、すべての「〇」を打つキーパターンがDAGに追加されてから、ノードマージ処理が行われます。「っしゅ」の「ゅ」の場合だと、ひらがな の経路でいうと一度に3文字を打つ (1)「っしゅ」、2文字と1文字の2回に分ける (2)「っし」→「ゅ」、1文字ずつ打つ (3)「っ」→「し」→「ゅ」の3種類の経路があります。この3種類のすべてのキーパターンがDAGに追加されてからノードマージ処理を実施することになります。

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/275020/3e0e1269-42fa-2467-d95e-2c6b1c6c5425.png" width="620px">

もしも途中でノードマージ処理を実施してしまうと、↑ のように一度マージして統合したノードをあとでもとに戻さなければいけないことが発生するからです。例えば「っ」のキーパターンが ↑ のように定義されているとします。"ltu","xtu"でノードマージしてtuが統合されたあとで、"ltsu"を追加してまた最後のuをマージしてしまうと、以下のように"xtsu"というキーパターンにはない経路がDAGに作られてしまいます。この場合の正確なDAGは、↑ の右のDAGです。最初に"x"を打つと、"xtsu"は定義されていないので、残りの経路は"t"→"u"の一本道になります。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/275020/4852880c-ae46-6859-5ec6-4491476942f8.png)

次にDAGは、1つの ひらがな の作成が終わったらその最終ノードから次の文字のノードが作られます。最終ノードが ↑ のように2つある場合には、その2つからそれぞれ次の文字のノードが作成されます。ただ ↑ では文字"△"のキーパターンがすべてDAGに追加されたあとで最後のノードはノードマージ処理されますので、"d"→"e"は1つだけが残ることになります。
必ず母音で終わる日本語では、複数のキー入力候補であってもローマ字入力では同じキーで1つの ひらがな は終わります。よって基本は ↑ のようなキーパターンの例はないのですが、例外は「ん」のケースです。「ん」は"nn"または"xn"で入力できるのですが、「ん」の次の文字が子音から始まる場合は、"n"の1つでも大丈夫です。もちろん"nn"と2つ打ってもよいので、この場合のみ「ん」の終了ノードは、"nn"の1つ目の"n"と2つ目の"n"の2か所となります。よって次の文字は、1つ目の"n"と2つ目の"n"の両方から経路が作成されます。

以上がDAG作成の処理の大まかなイメージです。

### 6.2. アルゴリズムの詳細

ここからは、より詳細にアルゴリズムについて述べていきます。

横型探索の要領で ひらがな からDAGを作成します。アルゴリズムは、同じキーは同じノードを共有し、別のキーがでてきたときに枝分かれするようにDAGを作成していきます。枝分かれしたエッジは1つの ひらがな が終わってから後ろから統合します。イメージとしてはツリーを作って、ツリーの下から同じノードを統合していく、という感じです。

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/275020/32224bda-8d21-297c-4460-c5e33391b262.png" width="620px">

ひらがな のタイピングパターンは ↑ のようになります。まず「ひ」のノードとして「h」「i」を作り、「っ」のノード、「っし」のノードと増やしていきます。ひらがな の1塊が終わるたびに後ろからノードを統合して処理の途中で不要にDAGが大きくなることを防ぎます。

以下は、アルゴリズムの詳細です。OPEN変数には、先にエッジが伸びる可能性があるノードを保管しておきます。OPENを「打ち終わった ひらがな」の文字数の昇順でソートすることにより、DAGはHEADに近い方から順に広がっていくイメージで作成されます。OPEN変数は、{p:ひらがな の何文字目か, parents:親ノード一覧} を要素とした配列です。

|手順|手順内番号|処理内容|
|:----|:----|:----|
|1| |OPENにp:0,親ノード:HEADとした要素を入れる|
|2|①|OPENの先頭を取り出す。これを n とする。OPENが空の場合は、処理を終了する。|
| |②|n.parentsのノードマージ処理をする。|
| |③|n.pから始まる文字列に一致する文字をCHAR_KEYS_TABLEからすべて抽出する。|
| |④|すべてのCHAR_KEYS_TABLE.charのすべてのkeysについて、同じキーを表すノードは複数作成せずに、異なるキーは枝分かれしながらn.parentsのすべてに子ノードとして追加する。ここでは枝分かれしたエッジは最後まで統合しないのでノードマージ処理がはいるまでは、一時的にノードは木構造となる。また1つのcharのkeysがすべて追加した時点で、p+char.lengthとしたOPENの要素を捜し、あればそのparentsにkeysで作成された最後のノードを追加する。なければ、新しいpを最後のノードとともにOPENに追加する。|
| |⑤|OPENのpの昇順でソートする。|
|3| |2の処理に戻る|

DAGの子ノードの方から親ノードを統合していく処理を「ノードマージ処理」と呼んでいます。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/275020/228d0d8f-6ee4-28cc-b2e4-a00ee95dbd23.png)

このノードマージ処理とは「同じキーを表す」かつ「子ノード一覧が同じ」なノードは、DAG上で1つにまとめることができるので、それらを統合します。それらの処理は、残るノードを parent, 置き換えられるのが parent-removedとしたとき、それぞれの子ノード一覧を children, children-removed、それぞれの親ノード一覧を granpas, granpas-removed とすると、次のようになります。

|手順|処理内容|
|:----|:----|
|1|すべてのchildren-removedの親ノード一覧から parent-removed を削除, すべてのgranpas-removed の子ノード一覧から parent-removed を削除（parent-removedの上下エッジの削除）|
|2|すべてのgranpas-removedの子に parent を追加、parentの親一覧にすべての granpas-removed を追加（親の引継ぎ）|
|3|parent-removed は以後の処理で使用しないようにするために _merged 変数を true にセットする。|

この処理でマージされずに残ったparentノードは、さらにその上の親ノードがマージできる可能性ができるため、parentの親ノード一覧のノードマージの対象として再帰的に処理する。

以上が ひらがな からDAGを作成するアルゴリズムです。

# 7. DAGの可視化

[オンラインデモ](https://toyohisa2nakada.github.io/typing/keygraph_visualizer.html)

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/275020/8cd4a918-a1cf-0b03-caa5-6acbca749d52.png)

ライブラリとは直接関係がないですが、DAGを可視化するアプリです。ひらがな を入力すると、そのキーパターンを表したDAGが表示されます。タブや改行も打つことができますが、DAG上では空白に見えるのでご注意ください。ソースコードは、上記のダウンロードのところから参照することができます。

<details><summary>DAGの表示について</summary><div>
いろいろなデータを可視化できるJavaScriptライブラリ <a href="https://d3js.org/">d3.js</a> の<a href="https://observablehq.com/@d3/force-directed-graph">グラフ描画のサンプル</a>を参考にさせていただいています。
</div></details>

# 8. 性能

DAGは複数の経路が作成されても ひらがな の1文字ずつの終わりの時点では基本は閉じて1経路になります。よって本アルゴリズムの計算量はO(n)です。ここで n は ひらがなの文字数です。

以下の環境で約1500文字の ひらがな は、約0.1秒でDAGを作成することができます。
Intel Core i7-8500Y 1.60 GHz, 16.0 GB RAM, 64 bit Windows 11, Chrome 113.0.5672.93, 調査日 2023年5月11日

一度DAGが作成されればキー入力の正誤判定はDAGのサイズに依存しないので、リアルタイムで処理できると思われます。

# 9. パブリックドメインソフトウェア

本ライブラリは、パブリックドメインソフトウェアです。パブリックドメインソフトウェアとは著作権を放棄したソフトウェアで、商用利用、再配布、改変などもちろん何でもOKです。

# 参考

[楽曲: 翔べ!_ガンダム](https://ja.wikipedia.org/wiki/%E7%BF%94%E3%81%B9!_%E3%82%AC%E3%83%B3%E3%83%80%E3%83%A0)

